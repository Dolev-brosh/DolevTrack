<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DolevTrack</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect width=%2224%22 height=%2224%22 rx=%225%22 fill=%22%2384cc16%22/><polyline points=%2222 12 18 12 15 21 9 3 6 12 2 12%22 fill=%22none%22 stroke=%22black%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              neon: {
                400: '#a3e635',
                500: '#84cc16',
                600: '#65a30d',
              },
              dark: {
                900: 'rgb(var(--c-dark-900) / <alpha-value>)',
                800: 'rgb(var(--c-dark-800) / <alpha-value>)',
                700: 'rgb(var(--c-dark-700) / <alpha-value>)',
              },
              white: 'rgb(var(--c-white) / <alpha-value>)',
              gray: {
                200: 'rgb(var(--c-gray-200) / <alpha-value>)',
                300: 'rgb(var(--c-gray-300) / <alpha-value>)', 
                400: 'rgb(var(--c-gray-400) / <alpha-value>)',
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            }
          }
        }
      }
    </script>
    
    <style>
      :root {
        --c-dark-900: 243 244 246;
        --c-dark-800: 255 255 255;
        --c-dark-700: 229 231 235;
        --c-white: 17 24 39;
        --c-gray-200: 55 65 81;
        --c-gray-300: 75 85 99;
        --c-gray-400: 107 114 128;
      }
      .dark {
        --c-dark-900: 9 9 11;
        --c-dark-800: 24 24 27;
        --c-dark-700: 39 39 42;
        --c-white: 255 255 255;
        --c-gray-200: 229 231 235;
        --c-gray-300: 209 213 219;
        --c-gray-400: 161 161 170;
      }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: rgb(var(--c-dark-800)); }
      ::-webkit-scrollbar-thumb { background: rgb(var(--c-dark-700)); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: rgb(var(--c-gray-400)); }
      body { transition: background-color 0.3s ease, color 0.3s ease; }
      @keyframes flash-highlight {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      .animate-flash { animation: flash-highlight 1.5s ease-in-out 3; }
    </style>

    <!-- React & Libraries (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Dependencies -->
    <!-- PropTypes is required for Recharts UMD -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.2/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react@0.344.0/dist/umd/lucide-react.min.js"></script>
    <script src="https://unpkg.com/framer-motion@11.0.8/dist/framer-motion.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "framer-motion": "https://esm.sh/framer-motion@^12.26.2",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body class="bg-dark-900 text-gray-200 antialiased min-h-screen transition-colors duration-300">
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-presets="env,react,typescript">
        // --- 1. Global Destructuring (Simulating Imports) ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, 
            ResponsiveContainer, PieChart, Pie, Cell 
        } = window.Recharts;
        const { 
            Save, Flame, Meh, Frown, TrendingDown, TrendingUp, Minus, BarChart2, 
            Edit2, Trash2, ChevronDown, ChevronUp, Droplets, Wheat, Cookie, 
            ClipboardList, Activity, Database, Sun, Moon, PlusCircle, List, 
            Target, Award, CheckCircle, X, AlertTriangle, Calendar: CalendarIcon, Download
        } = window.lucideReact;
        const { motion, AnimatePresence } = window.Motion;

        // --- 2. Types & Constants ---
        
        const STORAGE_KEY = 'nutrition_tracker_data_v1';
        const GOALS_KEY = 'nutrition_tracker_goals_v1';
        const THEME_KEY = 'nutrition_tracker_theme';
        const BADGE_CONFIG = {
          protein: {
            1: "https://i.ibb.co/d0H9k3w2/1pro.png", 
            10: "https://i.ibb.co/Fbfv8FS3/Gemini-Generated-Image-bh4apobh4apobh4a-1-3.png",
            30: "https://i.ibb.co/Nnp34YMd/Gemini-Generated-Image-bh4apobh4apobh4a-1-4.png",
            50: "https://i.ibb.co/mVc974ZQ/Gemini-Generated-Image-bh4apobh4apobh4a-1-5.png",
            70: "https://i.ibb.co/S7ZFN7v8/Gemini-Generated-Image-bh4apobh4apobh4a-1-6.png",
            100: "https://i.ibb.co/ccJ2zzhd/Gemini-Generated-Image-bh4apobh4apobh4a-1-7.png",
          },
          calories: {
            1: "https://i.ibb.co/hF0XPFkM/Gemini-Generated-Image-bh4apobh4apobh4a-1-8.png",
            10: "https://i.ibb.co/tMsDc9z9/Gemini-Generated-Image-bh4apobh4apobh4a-1-9.png",
            30: "https://i.ibb.co/QvQDSSRr/Gemini-Generated-Image-bh4apobh4apobh4a-1-10.png",
            50: "https://i.ibb.co/1tkqFby0/Gemini-Generated-Image-bh4apobh4apobh4a-1-11.png",
            70: "https://i.ibb.co/j9K1JG2N/Gemini-Generated-Image-bh4apobh4apobh4a-1-12.png",
            100: "https://i.ibb.co/QFDzsgZL/Gemini-Generated-Image-bh4apobh4apobh4a-1-13.png",
          }
        };

        const MILESTONES = [1, 10, 30, 50, 70, 100];

        // --- 3. Utilities ---

        const getLocalISODate = (date) => {
          const offset = date.getTimezoneOffset() * 60000;
          return new Date(date.getTime() - offset).toISOString().split('T')[0];
        };

        // --- 4. Components ---

        const Button = ({ children, variant = 'primary', fullWidth = false, className = '', ...props }) => {
          const baseStyle = "px-4 py-3 rounded-xl font-bold transition-all duration-200 active:scale-95 flex items-center justify-center gap-2";
          const variants = {
            primary: "bg-neon-400 text-black hover:bg-neon-500 shadow-lg shadow-neon-400/20",
            secondary: "bg-dark-700 text-white hover:bg-dark-600 border border-dark-600",
            danger: "bg-red-500/10 text-red-600 dark:text-red-400 border border-red-500/50 hover:bg-red-500/20",
            outline: "border-2 border-neon-400/50 text-neon-400 hover:bg-neon-400/10"
          };
          return (
            <button className={`${baseStyle} ${variants[variant]} ${fullWidth ? "w-full" : ""} ${className}`} {...props}>
              {children}
            </button>
          );
        };

        const Card = ({ children, className = '', title }) => {
          return (
            <div className={`bg-dark-800 rounded-2xl p-5 border border-dark-700 shadow-xl ${className}`}>
              {title && (
                <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  {title}
                </h3>
              )}
              {children}
            </div>
          );
        };

        const Input = ({ label, error, className = '', ...props }) => {
          const hasTextColor = className.includes('text-');
          const textColorClass = hasTextColor ? '' : 'text-white';
          return (
            <div className="flex flex-col gap-1.5 w-full">
              <label className={`text-xs font-bold uppercase tracking-wider ml-1 ${error ? 'text-red-600 dark:text-red-400' : 'text-gray-400'}`}>
                {label}
              </label>
              <input
                className={`w-full bg-dark-900 border rounded-xl px-4 py-3 focus:outline-none transition-colors text-lg placeholder-gray-400 dark:[color-scheme:dark] [color-scheme:light] ${textColorClass} ${
                  error ? 'border-red-500 focus:border-red-500 focus:ring-1 focus:ring-red-500' : 'border-dark-700 focus:border-neon-400 focus:ring-1 focus:ring-neon-400'
                } ${className}`}
                {...props}
              />
              {error && <span className="text-red-600 dark:text-red-400 text-xs font-bold mt-1 ml-1">{error}</span>}
            </div>
          );
        };

        const Calendar = ({ selectedDate, onSelect, existingDates, onClose }) => {
          const [currentMonth, setCurrentMonth] = useState(() => {
            const d = selectedDate ? new Date(selectedDate) : new Date();
            if (isNaN(d.getTime())) return new Date();
            return new Date(d.getFullYear(), d.getMonth(), 1);
          });

          const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
          const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();
          
          const daysInMonth = getDaysInMonth(currentMonth);
          const firstDay = getFirstDayOfMonth(currentMonth);

          const handleDayClick = (day) => {
            const year = currentMonth.getFullYear();
            const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            onSelect(`${year}-${month}-${dayStr}`);
          };

          const isSelected = (day) => {
            if (!selectedDate) return false;
            const [y, m, d] = selectedDate.split('-').map(Number);
            return y === currentMonth.getFullYear() && m === (currentMonth.getMonth() + 1) && d === day;
          };

          const hasData = (day) => {
            if (!existingDates) return false;
            const year = currentMonth.getFullYear();
            const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            return existingDates.has(`${year}-${month}-${dayStr}`);
          };

          const renderDays = () => {
            const days = [];
            ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].forEach(d => days.push(
              <div key={d} className="h-10 flex items-center justify-center text-xs font-bold text-gray-500 uppercase">{d}</div>
            ));
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} />);
            for (let d = 1; d <= daysInMonth; d++) {
              const selected = isSelected(d);
              const data = hasData(d);
              days.push(
                <button
                  key={d} type="button" onClick={() => handleDayClick(d)}
                  className={`h-10 w-10 rounded-full flex items-center justify-center text-sm font-medium transition-all relative ${selected ? 'bg-neon-400 text-black font-bold shadow-lg shadow-neon-400/30' : 'text-gray-200 hover:bg-dark-700'}`}
                >
                  {d}
                  {!selected && data && <div className="absolute bottom-1.5 w-1 h-1 rounded-full bg-blue-500"></div>}
                </button>
              );
            }
            return days;
          };

          return (
            <div className="bg-dark-800 p-4 rounded-2xl shadow-2xl border border-dark-700 w-full max-w-sm animate-in zoom-in-95 duration-200">
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} type="button" className="p-2 hover:bg-dark-700 rounded-xl text-gray-400 hover:text-white"><ChevronLeft/></button>
                <div className="font-bold text-white text-lg">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</div>
                <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} type="button" className="p-2 hover:bg-dark-700 rounded-xl text-gray-400 hover:text-white"><ChevronRight/></button>
              </div>
              <div className="grid grid-cols-7 gap-1 justify-items-center">{renderDays()}</div>
              <button onClick={onClose} type="button" className="mt-4 w-full py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-dark-700 rounded-xl transition-colors">Cancel</button>
            </div>
          );
        };
        
        // Inline icons for Calendar component since Lucide icons are destructured above, 
        // but let's make sure ChevronLeft/Right are available or mocked
        const ChevronLeft = window.lucideReact.ChevronLeft || (() => <span>&lt;</span>);
        const ChevronRight = window.lucideReact.ChevronRight || (() => <span>&gt;</span>);

        const DatePicker = ({ value, onChange, label, error, existingDates }) => {
          const [isOpen, setIsOpen] = useState(false);
          return (
            <>
              <div className="relative cursor-pointer group" onClick={() => setIsOpen(true)}>
                <Input label={label} value={value} onChange={() => {}} error={error} readOnly className="cursor-pointer pointer-events-none group-hover:border-gray-500 transition-colors" />
                <div className="absolute right-3 top-[34px] text-gray-400 group-hover:text-neon-400 transition-colors pointer-events-none"><CalendarIcon size={20} /></div>
                <div className="absolute inset-0 top-6 z-10" />
              </div>
              {isOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                  <div className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200" onClick={() => setIsOpen(false)} />
                  <div className="relative z-10 w-full max-w-xs">
                    <Calendar selectedDate={value} onSelect={(date) => { onChange(date); setIsOpen(false); }} existingDates={existingDates} onClose={() => setIsOpen(false)} />
                  </div>
                </div>
              )}
            </>
          );
        };

        const TrackerForm = ({ onSave, initialData, existingDates, userGoals }) => {
          const defaultForm = { date: '', weight: '', protein: '', fat: '', carbs: '', calories: 0 };
          const [formData, setFormData] = useState(defaultForm);
          const [errors, setErrors] = useState({});

          useEffect(() => {
            if (initialData) {
              setFormData({ ...initialData });
              setErrors({});
            } else {
              let date = new Date();
              for(let i=0; i<365; i++) {
                 const dStr = date.toISOString().split('T')[0];
                 if(!existingDates.has(dStr)) {
                   setFormData({ ...defaultForm, date: dStr });
                   break;
                 }
                 date.setDate(date.getDate() + 1);
              }
              setErrors({});
            }
          }, [initialData, existingDates]);

          const handleChange = (e) => {
            const { name, value } = e.target;
            const next = { ...formData, [name]: value };
            if (['protein', 'carbs', 'fat'].includes(name)) {
                next.calories = Math.round((Number(next.protein||0)*4) + (Number(next.carbs||0)*4) + (Number(next.fat||0)*9));
            }
            setFormData(next);
            if(errors[name]) setErrors(prev => { const n = {...prev}; delete n[name]; return n; });
          };

          const handleDateChange = (val) => {
             setFormData(prev => ({...prev, date: val}));
             if (existingDates.has(val) && val !== initialData?.date) {
                 setErrors(prev => ({ ...prev, date: 'Log already exists. Edit in History.' }));
             } else {
                 setErrors(prev => { const n={...prev}; delete n.date; return n; });
             }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if(errors.date) return;
            if(!formData.date || formData.weight==='' || formData.protein==='' || formData.carbs==='' || formData.fat==='') {
                setErrors({ ...errors, general: 'Fill all fields' }); 
                return; 
            }
            onSave({
                date: formData.date,
                weight: Number(formData.weight),
                protein: Number(formData.protein),
                fat: Number(formData.fat),
                carbs: Number(formData.carbs),
                calories: Number(formData.calories)
            });
          };

          const getMacroColor = (val, goal) => {
             if (!userGoals) return 'text-white';
             const v = Number(val);
             if (v <= goal) return 'text-green-600 dark:text-green-400';
             if (v <= goal + 10) return 'text-orange-500 dark:text-orange-400';
             return 'text-red-600 dark:text-red-400';
          };
          
          const getProteinColor = (val, goal) => {
             if (!userGoals) return 'text-white';
             const v = Number(val);
             if (v >= goal) return 'text-green-600 dark:text-green-400';
             if (v >= goal - 30) return 'text-orange-500 dark:text-orange-400';
             return 'text-red-600 dark:text-red-400';
          };

          let CalorieIcon = Flame;
          let calColor = 'text-white';
          if(userGoals) {
             const c = Number(formData.calories);
             if(c <= userGoals.calories) { calColor = 'text-green-600 dark:text-green-400'; CalorieIcon = Flame; }
             else if(c <= userGoals.calories + 150) { calColor = 'text-orange-500 dark:text-orange-400'; CalorieIcon = Meh; }
             else { calColor = 'text-red-600 dark:text-red-400'; CalorieIcon = Frown; }
          }

          return (
            <Card title={initialData ? "Edit Entry" : "New Entry"} className="mb-6">
              <form onSubmit={handleSubmit} className="flex flex-col gap-6">
                <DatePicker label="Date" value={formData.date} onChange={handleDateChange} error={errors.date} existingDates={existingDates} />
                <div className="grid grid-cols-3 gap-3">
                  <Input label="Protein (g)" type="number" name="protein" value={formData.protein} onChange={handleChange} className={userGoals ? getProteinColor(formData.protein, userGoals.protein) : ''} />
                  <Input label="Carbs (g)" type="number" name="carbs" value={formData.carbs} onChange={handleChange} className={userGoals ? getMacroColor(formData.carbs, userGoals.carbs) : ''} />
                  <Input label="Fat (g)" type="number" name="fat" value={formData.fat} onChange={handleChange} className={userGoals ? getMacroColor(formData.fat, userGoals.fat) : ''} />
                </div>
                <div className="grid grid-cols-2 gap-4 items-end">
                  <Input label="Weight (kg)" type="number" step="0.1" name="weight" value={formData.weight} onChange={handleChange} />
                  <div className="flex flex-col gap-1.5 w-full">
                    <span className={`text-xs font-bold uppercase tracking-wider ml-1 ${calColor}`}>Total Calories</span>
                    <div className="w-full bg-dark-900 border border-dark-700 rounded-xl px-4 py-3 flex items-center justify-between shadow-inner">
                       <span className={`text-xl font-bold tracking-wide ${calColor}`}>{formData.calories || 0}</span>
                       <CalorieIcon size={20} className={calColor} />
                    </div>
                  </div>
                </div>
                <Button type="submit" fullWidth disabled={!!errors.date}><Save size={20} />{initialData ? "Update Log" : "Save Log"}</Button>
              </form>
            </Card>
          );
        };

        const Charts = ({ logs, userGoals, theme = 'dark' }) => {
            const sortedLogs = [...logs].sort((a, b) => a.date.localeCompare(b.date));
            const today = new Date();
            const startOfCurrentWeek = new Date(today);
            startOfCurrentWeek.setDate(today.getDate() - today.getDay());
            const endOfCurrentWeek = new Date(startOfCurrentWeek);
            endOfCurrentWeek.setDate(startOfCurrentWeek.getDate() + 6);
            
            const getStats = () => {
                if(!userGoals) return null;
                const start = getLocalISODate(startOfCurrentWeek);
                const end = getLocalISODate(endOfCurrentWeek);
                const weekLogs = logs.filter(l => l.date >= start && l.date <= end);
                const totCal = weekLogs.reduce((acc,l)=>acc+l.calories,0);
                const goalCal = userGoals.calories*7;
                return {
                    calories: { current: totCal, total: goalCal, percent: Math.min(100, Math.round((totCal/goalCal)*100)), raw: Math.round((totCal/goalCal)*100) },
                    protein: { current: weekLogs.reduce((a,l)=>a+l.protein,0), total: userGoals.protein*7, percent: Math.min(100, Math.round((weekLogs.reduce((a,l)=>a+l.protein,0)/(userGoals.protein*7))*100)) },
                    carbs: { current: weekLogs.reduce((a,l)=>a+l.carbs,0), total: userGoals.carbs*7, percent: Math.min(100, Math.round((weekLogs.reduce((a,l)=>a+l.carbs,0)/(userGoals.carbs*7))*100)) },
                    fat: { current: weekLogs.reduce((a,l)=>a+l.fat,0), total: userGoals.fat*7, percent: Math.min(100, Math.round((weekLogs.reduce((a,l)=>a+l.fat,0)/(userGoals.fat*7))*100)) },
                };
            };
            
            const getWeightStats = () => {
                const s1 = new Date(startOfCurrentWeek); s1.setDate(s1.getDate()-7);
                const e1 = new Date(s1); e1.setDate(e1.getDate()+6);
                const avg = (s,e) => {
                   const f = logs.filter(l=>l.date>=s && l.date<=e && l.weight>0);
                   return f.length ? f.reduce((a,c)=>a+c.weight,0)/f.length : 0;
                }
                const cur = avg(getLocalISODate(startOfCurrentWeek), getLocalISODate(endOfCurrentWeek));
                const last = avg(getLocalISODate(s1), getLocalISODate(e1));
                return { currentAvg: cur, lastAvg: last, diff: cur - last };
            };

            const stats = getStats();
            const wStats = getWeightStats();

            if (logs.length === 0) return (
                <Card className="text-center py-12"><BarChart2 className="mx-auto text-gray-500 mb-4" size={48} /><h3 className="text-xl font-bold text-white mb-2">No Stats Available</h3><p className="text-gray-400">Once you start logging entries, your statistics and trends will appear here.</p></Card>
            );

            const gaugeColor = (stats?.calories.raw || 0) > 100 ? '#ef4444' : '#a3e635';
            const progressEndAngle = stats ? 180 - (180 * Math.min(stats.calories.percent, 100) / 100) : 180;

            return (
              <div className="flex flex-col gap-4 mb-6">
                {stats && (
                    <>
                    <Card title="Calorie Banking Weekly" className="flex flex-col items-center pt-2 pb-6">
                        <div className="relative w-full h-[140px] flex justify-center">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={[{value:1}]} dataKey="value" cx="50%" cy="100%" startAngle={180} endAngle={0} innerRadius={80} outerRadius={115} fill={theme==='dark'?'#27272a':'#e5e7eb'} stroke="none" />
                                    <Pie data={[{value:1}]} dataKey="value" cx="50%" cy="100%" startAngle={180} endAngle={progressEndAngle} innerRadius={80} outerRadius={115} fill={gaugeColor} stroke="none" />
                                </PieChart>
                            </ResponsiveContainer>
                            <div className="absolute bottom-0 flex flex-col items-center pb-1">
                                <Flame className={stats.calories.raw > 100 ? "text-red-500 mb-3" : "text-neon-500 mb-3"} size={22} />
                                <div className="flex items-baseline gap-1"><span className="text-3xl font-bold text-gray-900 dark:text-white">{stats.calories.current.toLocaleString()}</span><span className="text-sm text-gray-500 font-bold">/ {stats.calories.total}</span></div>
                            </div>
                        </div>
                    </Card>
                    <div className="grid grid-cols-3 gap-4">
                        {['carbs','protein','fat'].map(m => {
                           const cMap = { carbs: 'text-yellow-500', protein: 'text-blue-500', fat: 'text-red-500' };
                           const bgMap = { carbs: 'bg-yellow-500', protein: 'bg-blue-500', fat: 'bg-red-500' };
                           return (
                             <div key={m} className="bg-dark-800 rounded-2xl p-4 border border-dark-700 shadow-xl flex flex-col justify-between h-[110px]">
                                <span className="text-xs font-semibold text-gray-500 uppercase">{m}</span>
                                <div className="flex flex-col gap-2">
                                    <div className="flex items-baseline gap-0.5"><span className="text-lg font-bold text-gray-900 dark:text-white">{stats[m].current}</span><span className="text-[10px] text-gray-400">/ {stats[m].total}g</span></div>
                                    <div className="h-3 w-full bg-gray-200 dark:bg-dark-900 rounded-full overflow-hidden"><div className={`h-full ${bgMap[m]} rounded-full`} style={{width: `${stats[m].percent}%`}} /></div>
                                </div>
                             </div>
                           );
                        })}
                    </div>
                    </>
                )}
                <Card title="Weekly Weight Average">
                    <div className="flex items-center justify-between">
                        <div>
                            <div className="text-3xl font-bold text-gray-900 dark:text-white mb-1">{wStats.currentAvg > 0 ? wStats.currentAvg.toFixed(1) : '--'}<span className="text-lg text-gray-500 font-medium ml-1">kg</span></div>
                            <div className="text-sm text-gray-400">{wStats.lastAvg > 0 ? `vs ${wStats.lastAvg.toFixed(1)}kg last week` : 'No data last week'}</div>
                        </div>
                        {wStats.currentAvg > 0 && wStats.lastAvg > 0 && (
                            <div className={`p-3 rounded-2xl flex items-center justify-center ${wStats.diff < 0 ? 'bg-neon-400/10 text-neon-600 dark:text-neon-400' : wStats.diff > 0 ? 'bg-red-500/10 text-red-600 dark:text-red-400' : 'bg-gray-200 dark:bg-dark-700/50 text-gray-500'}`}>
                                {wStats.diff < 0 ? <TrendingDown size={32} /> : wStats.diff > 0 ? <TrendingUp size={32} /> : <Minus size={32} />}
                            </div>
                        )}
                    </div>
                </Card>
                <Card title="Weight Progress">
                    <div className="h-64 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={sortedLogs}>
                                <CartesianGrid strokeDasharray="3 3" stroke={theme==='dark'?'#27272a':'#e5e7eb'} />
                                <XAxis dataKey="date" stroke="#71717a" tick={{fill:'#71717a', fontSize:12}} tickFormatter={(val)=>val.slice(5)} />
                                <YAxis stroke="#71717a" tick={{fill:'#71717a', fontSize:12}} domain={['auto','auto']} />
                                <RechartsTooltip contentStyle={{backgroundColor: theme==='dark'?'#18181b':'#fff', borderColor: theme==='dark'?'#3f3f46':'#e5e7eb', borderRadius:'8px'}} itemStyle={{color: theme==='dark'?'#e4e4e7':'#111827'}} />
                                <Line type="monotone" dataKey="weight" stroke="#a3e635" strokeWidth={3} dot={{fill:'#a3e635'}} activeDot={{r:6, fill:'#fff'}} />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </Card>
              </div>
            );
        };

        const LogList = ({ logs, onEdit, onDelete, initialExpandedDate, highlightedFields = [], userGoals }) => {
            const [expandedDate, setExpandedDate] = useState(initialExpandedDate || null);
            useEffect(() => {
                if(initialExpandedDate) {
                    setTimeout(() => { document.getElementById(`log-row-${initialExpandedDate}`)?.scrollIntoView({behavior:'smooth', block:'center'}); }, 100);
                }
            }, [initialExpandedDate]);

            const sortedLogs = [...logs].sort((a,b) => b.date.localeCompare(a.date));
            const toggleRow = (d) => setExpandedDate(expandedDate === d ? null : d);
            const shouldFlash = (d,f) => initialExpandedDate === d && highlightedFields.includes(f);

            if(logs.length===0) return (<Card className="text-center py-12"><ClipboardList className="mx-auto text-gray-500 mb-4" size={48} /><h3 className="text-xl font-bold text-white mb-2">No History Yet</h3><p className="text-gray-400">Start logging your daily nutrition to see your history here.</p></Card>);

            return (
                <Card className="overflow-hidden p-0">
                    <div className="pt-6 pl-6 pb-4"><h3 className="text-lg font-semibold text-gray-900 dark:text-white">History</h3></div>
                    <div className="grid grid-cols-[1.5fr_1fr_1fr_40px] bg-dark-900/50 border-b border-dark-700 px-4 py-3 text-xs uppercase tracking-wider text-gray-400 font-bold"><div>Date</div><div>Weight</div><div>Cals</div><div></div></div>
                    <div className="flex flex-col">
                        <AnimatePresence initial={false} mode="popLayout">
                        {sortedLogs.map(log => {
                            const isExpanded = expandedDate === log.date;
                            const calColor = userGoals ? (log.calories <= userGoals.calories + 150 ? 'text-neon-600 dark:text-neon-400' : 'text-red-600 dark:text-red-400') : 'text-neon-600 dark:text-neon-400';
                            const metBoth = userGoals && (log.calories <= userGoals.calories + 150) && (log.protein >= userGoals.protein);
                            return (
                                <motion.div key={log.date} id={`log-row-${log.date}`} layout initial={{opacity:0, height:0}} animate={{opacity:1, height:'auto'}} exit={{opacity:0, height:0}} className={`border-b border-dark-700 last:border-0 overflow-hidden ${isExpanded ? 'bg-gray-50 dark:bg-dark-700/60' : 'hover:bg-gray-50 dark:hover:bg-dark-700/30'}`}>
                                    <div onClick={()=>toggleRow(log.date)} className="grid grid-cols-[1.5fr_1fr_1fr_40px] px-4 py-4 items-center cursor-pointer">
                                        <div className="font-medium text-gray-900 dark:text-white flex items-center gap-1.5">{metBoth && <span>ðŸ‘‘</span>}{new Date(log.date).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div>
                                        <div className="text-gray-600 dark:text-gray-300">{log.weight>0 ? <span className={shouldFlash(log.date,'weight')?'animate-flash font-bold':''}>{log.weight}kg</span> : '-'}</div>
                                        <div className={`${calColor} font-bold`}><span className={shouldFlash(log.date,'calories')?'animate-flash':''}>{log.calories}</span></div>
                                        <div className="text-right text-gray-400 flex justify-end">{isExpanded?<ChevronUp size={20}/>:<ChevronDown size={20}/>}</div>
                                    </div>
                                    <AnimatePresence>
                                        {isExpanded && (
                                            <motion.div initial={{opacity:0, height:0}} animate={{opacity:1, height:'auto'}} exit={{opacity:0, height:0}}>
                                                <div className="px-4 pb-3 pt-3 bg-gray-50 dark:bg-dark-900/40 shadow-inner">
                                                    <div className="flex flex-col gap-3">
                                                        <div className="grid grid-cols-3 gap-3 mt-2">
                                                            <div className="bg-transparent dark:bg-dark-800 rounded-xl p-3 border border-dark-700 flex flex-col items-center gap-1"><div className="flex items-center gap-1 text-[10px] font-bold uppercase text-blue-600 dark:text-blue-400"><Droplets size={12}/> Protein</div><span className="text-xl font-bold text-gray-900 dark:text-white">{log.protein}g</span></div>
                                                            <div className="bg-transparent dark:bg-dark-800 rounded-xl p-3 border border-dark-700 flex flex-col items-center gap-1"><div className="flex items-center gap-1 text-[10px] font-bold uppercase text-yellow-600 dark:text-yellow-400"><Wheat size={12}/> Carbs</div><span className="text-xl font-bold text-gray-900 dark:text-white">{log.carbs}g</span></div>
                                                            <div className="bg-transparent dark:bg-dark-800 rounded-xl p-3 border border-dark-700 flex flex-col items-center gap-1"><div className="flex items-center gap-1 text-[10px] font-bold uppercase text-red-600 dark:text-red-400"><Cookie size={12}/> Fat</div><span className="text-xl font-bold text-gray-900 dark:text-white">{log.fat}g</span></div>
                                                        </div>
                                                        <div className="flex gap-6 justify-between w-full pt-0">
                                                            <button onClick={(e)=>{e.stopPropagation();onEdit(log)}} className="flex items-center justify-center gap-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white font-medium px-4 py-2"><Edit2 size={18}/> Edit Entry</button>
                                                            <button onClick={(e)=>{e.stopPropagation();onDelete(log.date)}} className="flex items-center justify-center gap-2 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 font-medium px-4 py-2"><Trash2 size={18}/> Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </motion.div>
                                        )}
                                    </AnimatePresence>
                                </motion.div>
                            );
                        })}
                        </AnimatePresence>
                    </div>
                </Card>
            );
        };

        const BottomNav = ({ activeTab, onTabChange }) => {
          const navItems = [
            { id: 'entry', label: 'Log', icon: PlusCircle },
            { id: 'history', label: 'History', icon: List },
            { id: 'stats', label: 'Stats', icon: BarChart2 },
            { id: 'badges', label: 'Badges', icon: Award },
            { id: 'goals', label: 'Goals', icon: Target },
          ];
          return (
            <nav className="fixed bottom-0 left-0 right-0 bg-dark-900 border-t border-dark-700 pb-safe z-50 transition-colors duration-300">
              <div className="flex justify-between px-6 items-center h-16 max-w-md mx-auto sm:max-w-2xl">
                {navItems.map((item) => {
                  const Icon = item.icon;
                  const isActive = activeTab === item.id;
                  return (
                    <button key={item.id} onClick={() => onTabChange(item.id)} className={`flex flex-col items-center justify-center transition-colors duration-200 ${isActive ? 'text-neon-600 dark:text-neon-400' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}>
                      <Icon size={24} className={`mb-1 ${isActive ? 'stroke-[2.5px]' : 'stroke-2'}`} />
                      <span className="text-[10px] font-medium uppercase tracking-wide">{item.label}</span>
                    </button>
                  );
                })}
              </div>
            </nav>
          );
        };

        const Toast = ({ message, onClose }) => {
          useEffect(() => { const t = setTimeout(onClose, 2000); return () => clearTimeout(t); }, [onClose]);
          return (
            <div className="fixed top-4 left-4 right-4 z-[100] flex justify-center pointer-events-none">
              <motion.div initial={{opacity:0,y:-20,scale:0.9}} animate={{opacity:1,y:0,scale:1}} exit={{opacity:0,y:-20,scale:0.9}} className="pointer-events-auto w-full max-w-md bg-dark-800 border border-green-500/50 shadow-2xl shadow-green-500/10 rounded-xl p-4 flex items-center justify-between gap-3">
                <div className="flex items-center gap-3 overflow-hidden"><div className="text-green-600 dark:text-green-400 shrink-0"><CheckCircle size={24}/></div><p className="text-green-800 dark:text-green-50 text-sm font-medium truncate">{message}</p></div>
                <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-white/10 shrink-0"><X size={20}/></button>
              </motion.div>
            </div>
          );
        };

        const GoalForm = ({ currentGoals, onSave }) => {
          const [formData, setFormData] = useState(currentGoals || { calories: 2000, protein: 150, carbs: 200, fat: 60 });
          const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: Number(value) })); };
          return (
            <Card title="Daily Targets" className="mb-6">
              <div className="mb-6 bg-dark-900/50 p-4 rounded-xl border border-dark-700 text-sm text-gray-400 flex gap-3"><Target className="shrink-0 text-neon-400" size={20} /><p>Set your daily nutrition targets here.</p></div>
              <form onSubmit={(e)=>{e.preventDefault();onSave(formData)}} className="flex flex-col gap-6">
                <Input label="Daily Calories" type="number" name="calories" value={formData.calories||''} onChange={handleChange} placeholder="2000" />
                <div className="grid grid-cols-3 gap-3">
                  <Input label="Protein (g)" type="number" name="protein" value={formData.protein||''} onChange={handleChange} placeholder="150" />
                  <Input label="Carbs (g)" type="number" name="carbs" value={formData.carbs||''} onChange={handleChange} placeholder="200" />
                  <Input label="Fat (g)" type="number" name="fat" value={formData.fat||''} onChange={handleChange} placeholder="60" />
                </div>
                <Button type="submit" fullWidth><Save size={20} />Save Targets</Button>
              </form>
            </Card>
          );
        };

        const Modal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "Delete", cancelText = "Cancel", confirmVariant = "danger", icon = "alert" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose} />
                    <div className="relative bg-dark-800 border border-dark-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl scale-100 animate-in fade-in zoom-in-95 duration-200">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors"><X size={20} /></button>
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-2 ${icon === 'success' ? 'bg-neon-400/10 text-neon-400' : 'bg-red-500/10 text-red-500'}`}>{icon === 'success' ? <CheckCircle size={24} /> : <AlertTriangle size={24} />}</div>
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <p className="text-gray-400 leading-relaxed">{message}</p>
                            <div className="flex gap-3 w-full mt-4"><Button variant="secondary" fullWidth onClick={onClose}>{cancelText}</Button><Button variant={confirmVariant} fullWidth onClick={onConfirm}>{confirmText}</Button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Badges = ({ logs, userGoals }) => {
            const streaks = useMemo(() => {
                if (!userGoals || logs.length === 0) return { protein: 0, calories: 0 };
                const sortedLogs = [...logs].sort((a, b) => b.date.localeCompare(a.date));
                const checkProtein = (l) => l.protein >= userGoals.protein;
                const checkCalories = (l) => l.calories <= (userGoals.calories + 150);
                const calculate = (fn) => {
                    let streak = 0; let last = null;
                    for (let i = 0; i < sortedLogs.length; i++) {
                        const d = new Date(sortedLogs[i].date);
                        if (i === 0) { if (fn(sortedLogs[i])) { streak++; last = d; } else break; }
                        else {
                            if (!last) break;
                            const diff = Math.ceil(Math.abs(last.getTime() - d.getTime()) / (86400000));
                            if (diff === 1) { if (fn(sortedLogs[i])) { streak++; last = d; } else break; }
                            else if (diff > 1) break;
                        }
                    }
                    return streak;
                };
                return { protein: calculate(checkProtein), calories: calculate(checkCalories) };
            }, [logs, userGoals]);

            if (!userGoals) return <Card className="text-center py-10"><Award className="mx-auto text-gray-500 mb-2" size={48} /><h3 className="text-xl font-bold text-white mb-2">Set Goals First</h3></Card>;

            const BadgeItem = ({ m, s, type }) => {
                const un = s >= m;
                const size = type === 'calories' ? 'w-[9.6rem] h-[9.6rem]' : 'w-32 h-32';
                return (
                    <div className={`relative flex flex-col items-center justify-center transition-all duration-500 ${un ? 'opacity-100 scale-100' : 'opacity-40 grayscale scale-95'}`}>
                        <div className={`relative ${size} drop-shadow-2xl`}>
                            <img src={BADGE_CONFIG[type][m]} className="w-full h-full object-contain" onError={(e) => { e.currentTarget.src = "https://cdn-icons-png.flaticon.com/512/2382/2382461.png"; }} />
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col gap-6 animate-in fade-in duration-500 pb-8">
                    <div className="grid grid-cols-2 gap-4">
                        <Card className="flex flex-col items-center justify-center py-4 bg-gradient-to-br from-dark-800 to-blue-900/20 border-blue-900/30"><span className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Protein Streak</span><div className="flex items-center gap-2"><span className="text-3xl font-black text-white">{streaks.protein}</span><span className="text-sm text-blue-500 font-bold">Days</span></div></Card>
                        <Card className="flex flex-col items-center justify-center py-4 bg-gradient-to-br from-dark-800 to-orange-900/20 border-orange-900/30"><span className="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Calorie Streak</span><div className="flex items-center gap-2"><span className="text-3xl font-black text-white">{streaks.calories}</span><span className="text-sm text-orange-500 font-bold">Days</span></div></Card>
                    </div>
                    <div><h3 className="text-lg font-bold text-white mb-6 border-b border-dark-700 pb-2">Protein Collection</h3><div className="grid grid-cols-2 sm:grid-cols-3 gap-y-6 gap-x-2 place-items-center">{MILESTONES.map(m => <BadgeItem key={m} m={m} s={streaks.protein} type="protein" />)}</div></div>
                    <div><h3 className="text-lg font-bold text-white mb-6 border-b border-dark-700 pb-2">Calorie Collection</h3><div className="grid grid-cols-2 sm:grid-cols-3 gap-y-6 gap-x-2 place-items-center">{MILESTONES.map(m => <BadgeItem key={m} m={m} s={streaks.calories} type="calories" />)}</div></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
